// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// USERS & AUTHENTICATION
// ============================================================================

model User {
  id            String     @id @default(uuid())
  email         String     @unique
  password_hash String
  role          Role       @default(STUDENT)
  status        UserStatus @default(ACTIVE)
  created_at    DateTime   @default(now())
  updated_at    DateTime   @updatedAt
  deleted_at    DateTime?

  // Relations
  profile                  UserProfile?
  sessions                 Session[]
  audit_logs               AuditLog[]
  student_registrations    StudentRegistration[]
  enrollments              Enrollment[]
  payments                 Payment[]
  attendance_records       Attendance[]              @relation("StudentAttendance")
  marked_attendance        Attendance[]              @relation("MarkedBy")
  study_materials_uploaded StudyMaterial[]
  assignments_created      Assignment[]
  assignment_submissions   AssignmentSubmission[]
  graded_submissions       AssignmentSubmission[]    @relation("GradedBy")
  notifications            Notification[]
  announcements_created    Announcement[]
  email_logs               EmailLog[]
  batches_teaching         Batch[]

  @@index([email])
  @@index([role, status])
  @@map("users")
}

model UserProfile {
  id         String   @id @default(uuid())
  user_id    String   @unique
  name       String
  phone      String?
  address    String?
  photo_url  String?
  documents  Json?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}

model Session {
  id            String   @id @default(uuid())
  user_id       String
  refresh_token String   @unique
  expires_at    DateTime
  created_at    DateTime @default(now())

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([refresh_token])
  @@map("sessions")
}

model AuditLog {
  id         String   @id @default(uuid())
  user_id    String
  action     String
  entity     String
  entity_id  String
  old_value  Json?
  new_value  Json?
  ip_address String?
  user_agent String?
  created_at DateTime @default(now())

  user User @relation(fields: [user_id], references: [id])

  @@index([user_id])
  @@index([entity, entity_id])
  @@index([created_at])
  @@map("audit_logs")
}

model PasswordResetToken {
  id         String   @id @default(uuid())
  email      String
  token      String   @unique
  expires_at DateTime
  created_at DateTime @default(now())

  @@index([email])
  @@index([token])
  @@map("password_reset_tokens")
}

// ============================================================================
// ACADEMIC STRUCTURE
// ============================================================================

model Course {
  id            String       @id @default(uuid())
  title         String
  slug          String       @unique
  description   String       @db.Text
  thumbnail_url String?
  regular_price Decimal      @db.Decimal(10, 2)
  offer_price   Decimal?     @db.Decimal(10, 2)
  duration      Int
  category_id   String
  status        CourseStatus @default(DRAFT)
  created_by    String
  updated_by    String?
  created_at    DateTime     @default(now())
  updated_at    DateTime     @updatedAt
  deleted_at    DateTime?

  category Category @relation(fields: [category_id], references: [id])
  batches  Batch[]

  @@index([status])
  @@index([category_id])
  @@map("courses")
}

model Category {
  id          String   @id @default(uuid())
  name        String   @unique
  slug        String   @unique
  description String?  @db.Text
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  courses Course[]

  @@map("categories")
}

model Batch {
  id          String      @id @default(uuid())
  course_id   String
  name        String
  capacity    Int
  start_date  DateTime
  end_date    DateTime
  class_days  String[]
  class_time  String
  teacher_id  String
  status      BatchStatus @default(UPCOMING)
  created_by  String
  updated_by  String?
  created_at  DateTime    @default(now())
  updated_at  DateTime    @updatedAt
  deleted_at  DateTime?

  course          Course           @relation(fields: [course_id], references: [id])
  teacher         User             @relation(fields: [teacher_id], references: [id])
  enrollments     Enrollment[]
  attendance      Attendance[]
  study_materials StudyMaterial[]
  assignments     Assignment[]

  @@index([course_id, status])
  @@index([teacher_id])
  @@map("batches")
}

model Enrollment {
  id             String           @id @default(uuid())
  student_id     String
  batch_id       String
  status         EnrollmentStatus @default(PENDING)
  payment_status PaymentStatus    @default(PENDING)
  enrolled_at    DateTime?
  created_at     DateTime         @default(now())
  updated_at     DateTime         @updatedAt

  student  User      @relation(fields: [student_id], references: [id])
  batch    Batch     @relation(fields: [batch_id], references: [id])
  payments Payment[]

  @@unique([student_id, batch_id])
  @@index([batch_id, status])
  @@index([student_id])
  @@map("enrollments")
}

// ============================================================================
// STUDENT LIFECYCLE
// ============================================================================

model StudentRegistration {
  id               String             @id @default(uuid())
  student_id       String
  course_id        String
  batch_preference String?
  documents        Json
  status           RegistrationStatus @default(PENDING)
  admin_notes      String?            @db.Text
  
  academic_reviewed_by String?
  academic_reviewed_at DateTime?
  
  financial_verified_by String?
  financial_verified_at DateTime?
  
  approved_by      String?
  approved_at      DateTime?

  created_at       DateTime           @default(now())
  updated_at       DateTime           @updatedAt

  student User @relation(fields: [student_id], references: [id])

  @@index([status])
  @@index([student_id])
  @@map("student_registrations")
}

model Payment {
  id              String        @id @default(uuid())
  enrollment_id   String
  student_id      String
  amount          Decimal       @db.Decimal(10, 2)
  screenshot_url  String
  transaction_id  String        @unique
  phone_number    String
  payment_method  String
  notes           String?       @db.Text
  status          PaymentStatus @default(PENDING)
  approved_by     String?
  approved_at     DateTime?
  rejected_reason String?       @db.Text
  created_at      DateTime      @default(now())
  updated_at      DateTime      @updatedAt

  enrollment Enrollment @relation(fields: [enrollment_id], references: [id])
  student    User       @relation(fields: [student_id], references: [id])
  invoice    Invoice?

  @@index([enrollment_id])
  @@index([student_id, status])
  @@index([status])
  @@map("payments")
}

model Invoice {
  id             String   @id @default(uuid())
  payment_id     String   @unique
  invoice_number String   @unique
  pdf_url        String
  generated_by   String
  generated_at   DateTime @default(now())

  payment Payment @relation(fields: [payment_id], references: [id])

  @@index([invoice_number])
  @@map("invoices")
}

// ============================================================================
// ACADEMIC OPERATIONS
// ============================================================================

model Attendance {
  id         String           @id @default(uuid())
  batch_id   String
  student_id String
  date       DateTime         @db.Date
  status     AttendanceStatus @default(PRESENT)
  marked_by  String
  notes      String?
  created_at DateTime         @default(now())
  updated_at DateTime         @updatedAt

  batch   Batch @relation(fields: [batch_id], references: [id])
  student User  @relation("StudentAttendance", fields: [student_id], references: [id])
  marker  User  @relation("MarkedBy", fields: [marked_by], references: [id])

  @@unique([student_id, batch_id, date])
  @@index([batch_id, date])
  @@index([student_id])
  @@map("attendance")
}

model StudyMaterial {
  id          String       @id @default(uuid())
  batch_id    String
  title       String
  type        MaterialType
  file_url    String
  description String?      @db.Text
  uploaded_by String
  uploaded_at DateTime     @default(now())
  deleted_at  DateTime?

  batch    Batch @relation(fields: [batch_id], references: [id])
  uploader User  @relation(fields: [uploaded_by], references: [id])

  @@index([batch_id, type])
  @@map("study_materials")
}

model Assignment {
  id          String   @id @default(uuid())
  batch_id    String
  title       String
  description String   @db.Text
  deadline    DateTime
  total_marks Int
  file_url    String?
  created_by  String
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  deleted_at  DateTime?

  batch       Batch                  @relation(fields: [batch_id], references: [id])
  creator     User                   @relation(fields: [created_by], references: [id])
  submissions AssignmentSubmission[]

  @@index([batch_id, deadline])
  @@map("assignments")
}

model AssignmentSubmission {
  id            String   @id @default(uuid())
  assignment_id String
  student_id    String
  file_url      String
  submitted_at  DateTime @default(now())
  marks         Int?
  feedback      String?  @db.Text
  graded_by     String?
  graded_at     DateTime?

  assignment Assignment @relation(fields: [assignment_id], references: [id])
  student    User       @relation(fields: [student_id], references: [id])
  grader     User?      @relation("GradedBy", fields: [graded_by], references: [id])

  @@unique([assignment_id, student_id])
  @@index([assignment_id])
  @@index([student_id])
  @@map("assignment_submissions")
}

// ============================================================================
// COMMUNICATION & NOTIFICATIONS
// ============================================================================

model Notification {
  id         String           @id @default(uuid())
  user_id    String
  type       NotificationType
  title      String
  message    String           @db.Text
  is_read    Boolean          @default(false)
  created_at DateTime         @default(now())

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id, is_read])
  @@index([created_at])
  @@map("notifications")
}

model Announcement {
  id          String    @id @default(uuid())
  title       String
  content     String    @db.Text
  target_role Role?
  created_by  String
  created_at  DateTime  @default(now())
  deleted_at  DateTime?

  creator User @relation(fields: [created_by], references: [id])

  @@index([created_at])
  @@map("announcements")
}

model EmailLog {
  id         String      @id @default(uuid())
  user_id    String
  type       EmailType
  subject    String
  status     EmailStatus @default(PENDING)
  error      String?     @db.Text
  sent_at    DateTime?
  created_at DateTime    @default(now())

  user User @relation(fields: [user_id], references: [id])

  @@index([user_id, type])
  @@index([status])
  @@map("email_logs")
}

// ============================================================================
// ENUMS
// ============================================================================

enum Role {
  SUPER_ADMIN
  ADMIN
  TEACHER
  STAFF
  FINANCE
  STUDENT
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  INACTIVE
}

enum CourseStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum BatchStatus {
  UPCOMING
  ONGOING
  COMPLETED
  CANCELLED
}

enum EnrollmentStatus {
  PENDING
  ACTIVE
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  APPROVED
  REJECTED
  PARTIAL
}

enum RegistrationStatus {
  PENDING
  ACADEMIC_REVIEWED
  FINANCIAL_VERIFIED
  APPROVED
  REJECTED
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
}

enum MaterialType {
  PDF
  VIDEO
  NOTE
  ASSIGNMENT
}

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
}

enum EmailType {
  REGISTRATION_APPROVED
  REGISTRATION_REJECTED
  PAYMENT_APPROVED
  PAYMENT_REJECTED
  ASSIGNMENT_DEADLINE
  LOW_ATTENDANCE
}

enum EmailStatus {
  PENDING
  SENT
  FAILED
}
